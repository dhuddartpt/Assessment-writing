<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DPT Assessment Lab: ICD-10 & Logic Trainer</title>
    <style>
        :root { --touro-blue: #003057; --accent: #2980b9; --success: #27ae60; --error: #c0392b; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; line-height: 1.6; background: #f4f7f6; padding: 20px; }
        .container { max-width: 1150px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: var(--touro-blue); border-bottom: 2px solid #eee; padding-bottom: 8px; }
        .score-panel { position: sticky; top: 10px; background: var(--touro-blue); color: white; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 20px; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .case-box { background: #eef2f7; border-left: 6px solid var(--touro-blue); padding: 25px; border-radius: 8px; margin-bottom: 30px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .input-section { margin-bottom: 25px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; background: #fff; }
        label { font-weight: bold; color: var(--touro-blue); display: block; margin-bottom: 10px; }
        textarea { width: 100%; height: 100px; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 15px; box-sizing: border-box; resize: vertical; font-family: inherit; }
        .feedback-container { margin-top: 10px; font-size: 0.85em; }
        .pass { color: #155724; background: #d4edda; padding: 5px 10px; border-radius: 4px; margin: 2px 0; border-left: 4px solid var(--success); }
        .fail { color: #721c24; background: #f8d7da; padding: 5px 10px; border-radius: 4px; margin: 2px 0; border-left: 4px solid var(--error); }
        .btn { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-new { background: var(--accent); color: white; }
        .btn-dl { background: var(--success); color: white; width: 100%; margin-top: 20px; font-size: 1.1em; }
    </style>
</head>
<body>

<div class="container">
    <div class="score-panel">
        <strong>CURRENT GRADE: <span id="totalScore">0</span> / 11 pts</strong>
        <div id="gradeStatus" style="font-size: 0.85em; margin-top: 5px;">Awaiting complete ICD-10 and Clinical Documentation...</div>
    </div>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1>Clinical Assessment Trainer</h1>
        <button class="btn btn-new" onclick="generateRandomCase()">Generate New Random Case</button>
    </div>

    <div class="case-box" id="caseDisplay">
        <div class="grid">
            <div>
                <h3>Case Profile</h3>
                <p id="ptInfo"></p>
                <p><strong>Setting:</strong> <span id="settingInfo"></span></p>
                <p><strong>PLOF:</strong> <span id="plofInfo"></span></p>
                <p><strong>CLOF:</strong> <span id="clofInfo"></span></p>
            </div>
            <div>
                <h3>History & Objective Results</h3>
                <p id="onsetInfo"></p>
                <p id="contextInfo" style="font-style: italic; color: #555;"></p>
                <ul id="objectiveList" style="padding-left: 20px;"></ul>
            </div>
        </div>
    </div>

    <div class="input-section">
        <label>Section 1: Clinical Summary</label>
        <p style="font-size: 0.8em; color: #666; margin-bottom: 10px;">Required: Age, Sex, Setting, Medical Dx, <strong>ICD-10 Code</strong>, and Acuity (# days post-onset).</p>
        <textarea id="summaryIn" oninput="runGradingLogic()" placeholder="e.g., 68yo female in home health 3 days post-stroke (I63.9)..."></textarea>
        <div id="summaryFeedback" class="feedback-container"></div>
    </div>

    <div class="input-section">
        <label>Section 2: PT Assessment & Diagnosis</label>
        <textarea id="evalIn" oninput="runGradingLogic()" placeholder="Must use 'consistent' and link impairments to activity limitations..."></textarea>
        <div id="evalFeedback" class="feedback-container"></div>
    </div>

    <div class="input-section">
        <label>Section 3: Problem List</label>
        <textarea id="probIn" oninput="runGradingLogic()" placeholder="Impairments vs. Activity Limitations..."></textarea>
        <div id="probFeedback" class="feedback-container"></div>
    </div>

    <div class="input-section">
        <label>Section 4: Prognosis & Medical Necessity</label>
        <textarea id="progIn" oninput="runGradingLogic()" placeholder="Potential, Factors, Timeline, and Medical Necessity statement..."></textarea>
        <div id="progFeedback" class="feedback-container"></div>
    </div>

    <button class="btn btn-dl" onclick="downloadReport()">Validate & Download Final Note</button>
</div>

<script>
const conditions = [
    { name: "Cervical Spondylotic Myelopathy", code: "M50.022", sys: "neuromuscular", tests: ["Light touch impaired C6", "Hyperreflexia 3+ patellar", "Positive Hoffmann's sign", "3+/5 Wrist Extensor strength", "Ataxic gait noted"] },
    { name: "Acute Ischemic Stroke", code: "I63.9", sys: "neuromuscular", tests: ["R Hemiparesis (3/5)", "Spasticity R Elbow Flexors", "R Facial Droop", "Decreased R Proprioception", "Max A for Transfers"] },
    { name: "Post-op Total Knee Arthroplasty (L)", code: "Z96.651", sys: "musculoskeletal", tests: ["L Knee ROM: 5-85 deg", "3/5 Quadriceps strength", "Pain 7/10 with WB", "Min A for sit-to-stand", "RW for ambulation"] }
];

const contexts = [
    { age: "72", sex: "Female", setting: "Home Health", onset: "4 days ago", plof: "Independent; lives with spouse.", clof: "Requires physical assistance for mobility.", factors: "Highly motivated; home is 1-story." },
    { age: "58", sex: "Male", setting: "Acute Care", onset: "2 days ago", plof: "Independent; works full-time.", clof: "Requires 2-person assist; NPO status.", factors: "Non-compliant history; lives alone in 3rd floor apt." }
];

function generateRandomCase() {
    const cond = conditions[Math.floor(Math.random() * conditions.length)];
    const ctx = contexts[Math.floor(Math.random() * contexts.length)];
    document.getElementById('ptInfo').innerHTML = `<strong>Age:</strong> ${ctx.age} | <strong>Sex:</strong> ${ctx.sex} | <strong>Diagnosis:</strong> ${cond.name} (${cond.code})`;
    document.getElementById('settingInfo').innerText = ctx.setting;
    document.getElementById('plofInfo').innerText = ctx.plof;
    document.getElementById('clofInfo').innerText = ctx.clof;
    document.getElementById('onsetInfo').innerHTML = `<strong>Onset:</strong> ${ctx.onset}`;
    document.getElementById('contextInfo').innerText = ctx.factors;
    
    const objList = document.getElementById('objectiveList');
    objList.innerHTML = '';
    cond.tests.forEach(t => { const li = document.createElement('li'); li.innerText = t; objList.appendChild(li); });
    
    document.querySelectorAll('textarea').forEach(t => t.value = '');
    runGradingLogic();
}

function runGradingLogic() {
    const sm = document.getElementById('summaryIn').value.toUpperCase(); // For ICD code matching
    const ev = document.getElementById('evalIn').value.toLowerCase();
    const pb = document.getElementById('probIn').value.toLowerCase();
    const pg = document.getElementById('progIn').value.toLowerCase();
    
    let pts = 0;
    let smF = [], evF = [], pbF = [], pgF = [];

    // --- Section 1 Summary (3 pts) ---
    // ICD-10 Regex: Matches letter followed by 2 numbers, a dot, then more characters (standard code format)
    const icdPattern = /[A-Z][0-9][0-9]\.[0-9A-Z]{1,4}/;
    if (icdPattern.test(sm)) { pts++; smF.push("✓ ICD-10 Code present (1pt)"); } else { smF.push("✗ Missing ICD-10 Code (e.g., M50.022) (0pt)"); }
    
    if (sm.includes('MALE') || (sm.includes('YEAR') || sm.includes('YO'))) { pts++; smF.push("✓ Demographics (Age/Sex/Dx) present (1pt)"); } else { smF.push("✗ Missing Age/Sex/Dx (0pt)"); }
    
    if (sm.includes('DAYS') || sm.includes('ONSET') || sm.includes('ACUTE')) { pts++; smF.push("✓ Setting/Acuity specified (1pt)"); } else { smF.push("✗ Missing Setting or Onset data (0pt)"); }

    // --- Section 2 Assessment (3 pts) ---
    if (ev.includes('consistent')) { pts++; evF.push("✓ Rationale identifies consistency (1pt)"); } else { evF.push("✗ Missing 'consistent' rationale (0pt)"); }
    if (ev.includes('system') || ev.includes('neuromuscular') || ev.includes('musculoskeletal')) { pts++; evF.push("✓ Body system involvement noted (1pt)"); } else { evF.push("✗ Specify body system (0pt)"); }
    if (ev.includes('because') || ev.includes('secondary') || ev.includes('due to')) { pts++; evF.push("✓ Bridge: Impairment linked to Activity (1pt)"); } else { evF.push("✗ Bridge impairment to functional limitation (0pt)"); }

    // --- Section 3 Problem List (2 pts) ---
    if (pb.includes('impairment') && pb.includes('activity')) { pts++; pbF.push("✓ ICF Categories labeled (1pt)"); } else { pbF.push("✗ Label Impairments vs. Activities (0pt)"); }
    if (pb.length > 50) { pts++; pbF.push("✓ Logical problem list depth (1pt)"); } else { pbF.push("✗ List lacks sufficient detail (0pt)"); }

    // --- Section 4 Prognosis & Necessity (3 pts) ---
    if (pg.includes('motivation') || pg.includes('home') || pg.includes('barrier') || pg.includes('support')) { pts++; pgF.push("✓ Contextual factors included (1pt)"); } else { pgF.push("✗ Address contextual factors (0pt)"); }
    if (pg.includes('week') || pg.includes('month') || pg.includes('discharge') || pg.includes('dc')) { pts++; pgF.push("✓ Timeline and DC expectation present (1pt)"); } else { pgF.push("✗ Missing timeline or expectation (0pt)"); }
    if (pg.includes('necessity') || pg.includes('requires') || pg.includes('skilled') || pg.includes('benefit')) { pts++; pgF.push("✓ Medical necessity/Benefit statement (1pt)"); } else { pgF.push("✗ Missing Medical Necessity statement (0pt)"); }

    document.getElementById('totalScore').innerText = pts;
    renderF('summaryFeedback', smF); renderF('evalFeedback', evF); renderF('probFeedback', pbF); renderF('progFeedback', pgF);
}

function renderF(id, arr) { document.getElementById(id).innerHTML = arr.map(m => `<div class="${m.startsWith('✓')?'pass':'fail'}">${m}</div>`).join(''); }

function downloadReport() {
    const content = `PT STUDENT EVALUATION\nScore: ${document.getElementById('totalScore').innerText}/11\n\nSUMMARY:\n${document.getElementById('summaryIn').value}\n\nASSESSMENT:\n${document.getElementById('evalIn').value}\n\nPROBLEM LIST:\n${document.getElementById('probIn').value}\n\nPROGNOSIS & NECESSITY:\n${document.getElementById('progIn').value}`;
    const blob = new Blob([content], {type: 'text/plain'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'PT_Assessment_Full.txt'; a.click();
}
generateRandomCase();
</script>
</body>
</html>